name: Split for AI Automation

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'ai-chunks/**'
      - '.chroma/**'
      - '*.md'
      - '.github/**'
  workflow_dispatch:

jobs:
  split-for-ai:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install specific dependencies for the script
          pip install chromadb openai tqdm
          # Install from requirements.txt if it exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
      - name: Check OPENAI_API_KEY
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "❌ Error: OPENAI_API_KEY secret is not set"
            echo "Please add your OpenAI API key to repository secrets"
            exit 1
          fi
          
      - name: Run split-for-ai script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANONYMIZED_TELEMETRY: "False"
          CHROMA_DB_IMPL: "duckdb+parquet"
        run: |
          echo "🔍 Running split-for-ai script..."
          python utils/split-for-ai.py \
            --repo . \
            --max-lines 800 \
            --min-lines 50 \
            --db .chroma \
            --collection promptstrike
            
      - name: Check for changes
        id: check_changes
        run: |
          mkdir -p ai-chunks .chroma

          if [ -d "ai-chunks" ] && [ "$(find ai-chunks -name '*.md' | wc -l)" -gt 0 ]; then
             git add ai-chunks/ .chroma/
             if git diff --staged --quiet; then
             echo "changes=false" >> $GITHUB_OUTPUT
             echo "ℹ️ No changes detected"
             else
              echo "changes=true" >> $GITHUB_OUTPUT
             echo "✅ Changes detected in ai-chunks"
              fi
             else
             echo "changes=false" >> $GITHUB_OUTPUT
             echo "⚠️ No ai-chunks files generated"
             fi

          

         
          
      - name: Create/update ai-chunks-sync branch
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          # Configure git
          git config --local user.name 'github-actions[bot]'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # Get current commit info
          CURRENT_COMMIT=$(git rev-parse HEAD)
          CURRENT_SHORT=$(git rev-parse --short HEAD)
          
          # Check if ai-chunks-sync branch exists on remote
          if git ls-remote --exit-code --heads origin ai-chunks-sync >/dev/null 2>&1; then
            echo "📝 Updating existing ai-chunks-sync branch"
            git fetch origin ai-chunks-sync
            git checkout -B ai-chunks-sync origin/ai-chunks-sync
          else
            echo "🆕 Creating new ai-chunks-sync branch"
            git checkout -b ai-chunks-sync
          fi
          
          # Copy new changes
          git checkout main -- ai-chunks/ .chroma/ 2>/dev/null || true
          git add ai-chunks/ .chroma/
          
          # Commit with detailed message
          git commit -m "chore: update AI chunks from ${CURRENT_SHORT}

          Auto-generated by split-for-ai.py
          
          📊 Summary:
          - Source commit: ${CURRENT_COMMIT}
          - Workflow run: ${{ github.run_number }}
          - Trigger: ${{ github.event_name }}
          - Files processed: $(find ai-chunks -name "*.md" -type f 2>/dev/null | wc -l || echo '0')
          
          🔗 View changes: ${{ github.server_url }}/${{ github.repository }}/commit/${CURRENT_COMMIT}"
          
          # Push to remote
          git push origin ai-chunks-sync
          
      - name: Create Pull Request (optional)
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai-chunks-sync
          base: main
          title: "🤖 Auto-update AI chunks"
          body: |
            ## 🤖 Automated AI Chunks Update
            
            This PR contains updated AI-ready chunks generated from the latest changes.
            
            ### 📊 Summary
            - **Source commit**: `${{ github.sha }}`
            - **Files processed**: Automatically detected text files
            - **Chunk size**: 50-800 lines per chunk
            - **Database**: ChromaDB with OpenAI embeddings
            
            ### 🔄 What's included
            - Updated `ai-chunks/` directory with markdown chunks
            - Updated `.chroma/` vector database
            
            ### ⚡ Auto-merge
            This PR can be safely auto-merged as it only contains generated content.
            
            ---
            *Generated by [Split for AI Automation](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            automated
            ai-chunks
            enhancement
          draft: false
          
      - name: Generate summary
        if: always()
        run: |
          echo "## 🤖 Split for AI Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "✅ **Status**: AI chunks updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "📊 **Files processed**: $(find ai-chunks -name "*.md" -type f 2>/dev/null | wc -l || echo 'Unknown')" >> $GITHUB_STEP_SUMMARY
            echo "💾 **Database size**: $(du -sh .chroma 2>/dev/null | cut -f1 || echo 'Unknown')" >> $GITHUB_STEP_SUMMARY
            echo "🌿 **Branch**: \`ai-chunks-sync\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **Status**: No changes detected" >> $GITHUB_STEP_SUMMARY
            echo "The AI chunks are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔗 Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View ai-chunks-sync branch](${{ github.server_url }}/${{ github.repository }}/tree/ai-chunks-sync)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Source commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY